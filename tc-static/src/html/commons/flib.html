<!-- + post-lib -->
<!-- @build see glupfile.js / mg-script-libs -->
<script src="/tc-static/src/resources/libs/_flib.min.js"
        type="text/javascript"></script>
<!-- @build -->

<style type="text/css">
    /** privilege infrastructure */
    .tc-pv-control {
        visibility: hidden;
    }
</style>

<script type="text/javascript">
    // system infrastructure
    var TcC = {

        _openApiBase: '${openApiBase}',

        _staticBase: '${staticBase}',

        // ajax helper func
        doWithTcR: function (tcR, okCallback, exCallback) {
            if (_.isUndefined(tcR)) {
                layer.alert('系统繁忙，请稍后再试！');
            }
            if (tcR.code == 200) {
                if (_.isFunction(okCallback)) {
                    okCallback(tcR.body);
                } else {
                    // do nothing
                }
            } else {
                if (_.isFunction(exCallback)) {
                    exCallback(tcR.code, tcR.message, tcR.extra);
                } else {
                    layer.msg('系统异常，请刷新页面再试！');
                }
            }
        },

        defaultAxiosExHandler: function (error) {
            layer.alert('抱歉，系统异常，请稍后再试！');
        }
    };

    // axios infrastructure
    var TcAxios = {

        axiosConfig: {
            baseURL: TcC._openApiBase,
            // 6s
            timeout: 6000,
            xsrfCookieName: 'XSRF-TOKEN',
            xsrfHeaderName: 'X-XSRF-TOKEN',
            // 50k
            maxContentLength: 51200
        }

    };

    (function () {
        // Add a request interceptor
        axios.interceptors.request.use(function (config) {
            return config;
        }, function (error) {
            TcC.defaultAxiosExHandler(error);
            return Promise.reject(error);
        });

        // Add a response interceptor
        axios.interceptors.response.use(function (response) {
            return response;
        }, function (error) {
            TcC.defaultAxiosExHandler(error);
            return Promise.reject(error);
        });
    })();

    // privilege infrastructure (will extends by every page vue)
    var _TcPi = {

        data: {

            _Pi: {
                authenticated: null,

                roles: null,

                permissions: null
            }

        },

        mounted: function () {
        },

        watch: {
            roles: function (currVal, oldVal) {
                // nothing to do
            },

            permissions: function (currVal, oldVal) {
                if (!_.isNull(currVal) && _.isArray(currVal)) {
                    var stringPermissions = [];
                    var $pvControlElements = $('.tc-pv-control');
                    var $authorizedElements = $pvControlElements.filter(function (index, element) {
                        return _.contains(stringPermissions, $(element).data('pms'));
                    });
                    var $unauthorizedElements = $pvControlElements.filter(function (index, element) {
                        return !_.contains(stringPermissions, $(element).data('pms'));
                    });
                    $authorizedElements.each(function (index, element) {
                        var methods = $(element).data('invoke-when-authorized');
                        if (!_.isUndefined(methods)) {
                            this._invokePvMethod(methods);
                        }
                        $(this).remove();
                    });
                    $unauthorizedElements.each(function (index, element) {
                        var methods = $(element).data('invoke-when-unauthorized');
                        if (!_.isUndefined(methods)) {
                            this._invokePvMethod(methods);
                        }
                        $(this).remove();
                    });
                }
            },

            _invokePvMethod: function (methods) {
                try {
                    _.each(methods.split(','), function (method) {
                        if (_.isFunction(this.builtinAuthMethod[method])) {
                            this.builtinAuthMethod[method]();
                        }
                    });
                } catch (e) {
                    console.error(e);
                }
            }
        },

        methods: {

            builtinAuthMethod: {

                noClick: function () {

                }

            },

            doGetAuthenticatedStatus: function () {
                axios
                    .get(TcC.openApiBase('/auths/authenticated.json'), TcC.axiosConfig)
                    .then(function (response) {
                        TcC.doWithTcR(response.data, function (body) {
                            TcPi.authenticated = body;
                        });
                    })
                    .catch(function (error) {
                        TcC.defaultAxiosExHandler(error);
                    });
            },

            doGetRoles: function () {
                axios
                    .get(TcC.openApiBase('/auths/get_permissions.json'), TcC.axiosConfig)
                    .then(function (response) {
                        TcC.doWithTcR(response.data, function (body) {
                            TcPi.roles = body;
                        });
                    })
                    .catch(function (error) {
                        TcC.defaultAxiosExHandler(error);
                    });
            },

            doGetPermissions: function () {
                axios
                    .get(TcC.openApiBase('/auths/get_permissions.json'), TcC.axiosConfig)
                    .then(function (response) {
                        TcC.doWithTcR(response.data, function (body) {
                            TcPi.permissions = body;
                        });
                    })
                    .catch(function (error) {
                        TcC.defaultAxiosExHandler(error);
                    });
            }
        }

    };
</script>
<!-- - post-lib -->