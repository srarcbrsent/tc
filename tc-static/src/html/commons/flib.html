<!-- + post-lib -->
<!-- @build see glupfile.js / mg-script-libs -->
<script src="/tc-static/src/resources/libs/_flib.min.js"
        type="text/javascript"></script>
<!-- @build -->

<style type="text/css">
    [v-cloak] {
        display: none;
    }
</style>

<script type="text/javascript">
    // system infrastructure
    var _TcC = {

        _openApiBase: '${openApiBase}',

        _staticBase: '${staticBase}',

        // ajax helper func
        doWithTcR: function (tcR, okCallback, otherCallback, badRequestCallback, exCallback) {
            if (_.isUndefined(tcR)) {
                layer.alert('系统繁忙，请稍后再试！');
            }
            if (tcR.code == 0) {
                if (_.isFunction(okCallback)) {
                    okCallback(tcR.body);
                } else {
                    // do nothing
                }
            } else if (tcR.code == 8888) {
                if (_.isFunction(badRequestCallback)) {
                    badRequestCallback(tcR.code, tcR.message, tcR.extra);
                } else {
                    layer.msg('系统繁忙，请刷新页面再试！');
                }
            } else if (tcR.code == 9999) {
                if (_.isFunction(exCallback)) {
                    exCallback(tcR.code, tcR.message, tcR.extra);
                } else {
                    layer.msg('系统异常，请刷新页面再试！');
                }
            } else {
                if (_.isFunction(otherCallback)) {
                    otherCallback(tcR.code, tcR.message, tcR.extra);
                } else {
                    // do nothing
                }
            }
        },

        defaultAxiosExHandler: function (error) {
            layer.alert('抱歉，系统异常，请稍后再试！');
        }
    };

    // axios infrastructure
    var _TcAxios = axios.create({

        baseURL: _TcC._openApiBase,

        // 6s
        timeout: 6000,

        xsrfCookieName: 'XSRF-TOKEN',

        xsrfHeaderName: 'X-XSRF-TOKEN',

        // 50k
        maxContentLength: 51200

    });

    (function () {
        // Add a request interceptor, only logic, do nothing
        _TcAxios.interceptors.request.use(function (config) {
            return config;
        }, function (error) {
            return Promise.reject(error);
        });

        // Add a response interceptor, only logic, do nothing
        _TcAxios.interceptors.response.use(function (response) {
            if (_.isUndefined(response)) {
                throw new Error('empty response');
            }
            return response;
        }, function (error) {
            return Promise.reject(error);
        });
    })();

    // privilege infrastructure
    var privilegeVue = new Vue({

        el: 'body',

        data: {

            authenticated: false,

            permissions: []

        },

        mounted: function () {
            this.doGetAuthenticatedStatus();
            this.doGetPermissions();
        },

        methods: {

            doGetAuthenticatedStatus: function () {
                _TcAxios
                    .get('/auths/authenticated.json')
                    .then(function (response) {
                        _TcC.doWithTcR(response.data, function (body) {
                            privilegeVue.authenticated = body;
                        });
                    })
                    .catch(function (error) {
                        _TcC.defaultAxiosExHandler(error);
                    });
            },

            doGetPermissions: function () {
                _TcAxios
                    .get('/auths/get_permissions.json')
                    .then(function (response) {
                        _TcC.doWithTcR(response.data, function (body) {
                            privilegeVue.permissions = body;
                        });
                    })
                    .catch(function (error) {
                        _TcC.defaultAxiosExHandler(error);
                    });
            }

        },

        computed: {

            hasPermission: function (permission) {
                return !_.isUndefined(permission) && _.contains(this.permissions, permission);
            },

            hasAnyPermission: function (permissions) {
                return !_.isUndefined(permissions)
                    && _.intersection(this.permissions, permissions.split(',')).length > 0;
            },

            hasAllPermissions: function (permissions) {
                return !_.isUndefined(permissions)
                    && _.union(this.permissions, permissions.split(',')).length == this.permissions.length;
            }

        }
    });
</script>
<!-- - post-lib -->